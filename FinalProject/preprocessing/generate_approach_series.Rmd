#generate dataset of approach, gate passage, etc for each subject

```{r}
rm(list=ls())
library(zoo)
```

#derive
```{r}
derive <- function(time, angle) {
  
  dt <- c(time[1], time[2:nrow(pos)] - time[1:(nrow(pos)-1)]) / 1000
  dy <- c(angle[1], angle[2:nrow(pos)] - angle[1:(nrow(pos)-1)])
  da <- dy / dt
  
}
```

#find closest passage point
```{r}
find_passage_point <- function(prev_passage, position_data, gate_position) {
  min_distance <- 10000
  if ((prev_passage + 800) > nrow(position_data)) {
    end <- nrow(position_data)
  } else {end <- prev_passage + 800}

  for (row in prev_passage:end) {
      distance <- sqrt((position_data$Position.x.[row] - gate_position$X)^2 +
                       (position_data$Position.z.[row] - gate_position$Z)^2)

      if (distance < min_distance) {
        min_distance <- distance
        closest_row <- row
        }
  }
  as.integer(closest_row)
}
```

#find closest timestamp if no perfect match
```{r}
find_closest <- function(prev_passage, Timestamps, passage) {
  closest <- 10000000000000
  if ((prev_passage + 500) > length(Timestamps)) {
    end <- length(Timestamps)
  } else {end <- prev_passage + 500}
  
  for (row in prev_passage:end) {
    difference <- abs(passage - Timestamps[row])
    if (difference < closest) {
      closest <- difference
      closest_row <- row
      }
  }
  as.integer(closest_row)
}
```

#get gates
```{r}
setwd("../../subjects exp 1.1/Exp1.1_Sp23_PilotTestFull")

participants <- list.files(pattern="P_")

all_gates <- data.frame()

for (i in 1:length(participants)) {
#for (i in 1:2) {
  if (i==4) {next}
  setwd(participants[i])
  setwd("S001")
        
  conditions <- read.csv("conditions.csv")
  
  trial <- as.numeric(which((conditions$lookaheadCondition==7 | conditions$lookaheadCondition=="full") & conditions$orientationCondition=="original"))
  
  blocks <- list.files(pattern="Flight Data")
  setwd(blocks[trial])
  setwd(list.files(pattern="GaiaTest"))
  
  temp <- read.delim("gate_data.txt")
  temp$Subject <- i
  
  all_gates <- rbind(all_gates, temp)
  
  setwd("../../../..")
}

write.csv(all_gates, "all_gates.csv", row.names=FALSE)

```

#main
```{r}
gates <- read.csv("gateOriginalConfig.csv")

full_data <- data.frame()

setwd("coord-convert")
files <- list.files(pattern="subject")

for (i in 1:length(files)) {
  for (lap in 0:1) {
    
    # get data
    pos <- read.csv(files[i])
    pos <- pos[,-c(6, 8, 9:12)]
    #gates <- subset(all_gates, Subject==i & Lap==lap)

    # get instantaneous angular velocity, acceleration
    pos$d_ang <- derive(pos$Timestamp, pos$Orientation.y.)
    pos <- na.omit(pos)
    pos$d_ang <-  rollmean(pos$d_ang, k = 10, fill = NA, align = "center")

    pos$ang_accel <- derive(pos$Timestamp, pos$d_ang)
    pos$ang_accel <- rollmean(pos$ang_accel, k=10, fill=NA, align="center")
    pos <- na.omit(pos)
    
    #determine which gate is upcoming
    pos$Gate_N <- NA
    pos$Gate_Ang <- NA
    
    prev_passage <- 1
    for (gate in 1:32) {
      
      passed <- find_passage_point(prev_passage, pos, all_gates[gate,])
      passed <- as.integer(passed)
      
      pos$Gate_N[prev_passage:passed] <- gate
      pos$Gate_Ang[prev_passage:passed] <- all_gates$Angle_Deg[gate]
      prev_passage <- passed + 1
    }
    
    pos$Gate_N[is.na(pos$Gate_N)] <- 1
    
    pos <- subset(pos, Gaze.x. > 0 & Gaze.y. > 0 & Gaze.x. < 2560 & Gaze.y. < 1080)
    pos <- pos[,-c(4, 16, 17)]
    
    for (i in 1:32) {
      pos$Gate.x.[pos$Gate_N==i] <- gates$X[i]
      pos$Gate.z.[pos$Gate_N==i] <- gates$Z[i]
    }

    temp <- pos
    temp$Position.x <- pos$Position.x. + 600
    temp$Position.z. <- pos$Position.z. + 600
    temp$Gate.x. <- pos$Gate.x. + 600
    temp$Gate.z. <- pos$Gate.z. + 600
    
    x1 <- c(NA, temp$Position.x.[1:(nrow(temp)-1)]) - temp$Position.x.
    z1 <- c(NA, temp$Position.z.[1:(nrow(temp)-1)]) - temp$Position.z.
    x2 <- temp$Gate.x. - temp$Position.x.
    z2 <- temp$Gate.z. - temp$Position.z.
    
    mag <- sqrt((x2 - temp$Position.x.)^2 + (z2 - temp$Position.z.)^2)
    
    pos$Ang_Pos <- acos((x1 * x2 + z1 * z2)/mag)
    pos$Ang_Pos <- (pos$Ang_Pos * 180 / pi) - 90
    
    full_data <- rbind(full_data, pos)
  }
}

write.table(full_data, "full_data.csv", row.names=FALSE, quote=FALSE, sep=';')

```